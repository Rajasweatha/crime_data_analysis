{{ config(
    materialized = 'incremental'
) }}

WITH RAW_DATA AS (
  SELECT * 
  FROM {{ ref('stage_crime_data') }}
),

TRANSFORMED_DATA AS (
  SELECT
    CRIME_ID,
    TRY_TO_DATE(MONTH || '-01') AS CRIME_DATE,
    REPORTED_BY,
    FALLS_WITHIN,
    LONGITUDE,
    LATITUDE,
    REGEXP_REPLACE(LOCATION, 'On or near ', '') AS UPDATED_LOCATION,
    LSOA_CODE,
    LSOA_NAME,
    CRIME_TYPE,
    LAST_OUTCOME,
    CONTEXT,
    LAST_UPDATED
  FROM RAW_DATA
  WHERE UPDATED_LOCATION != 'No Location'

  {% if is_incremental() %}
    AND LAST_UPDATED > (SELECT MAX(LAST_UPDATED) FROM {{ this }})
  {% endif %}
),

DEDUPLICATED_DATA AS (
  SELECT * FROM 
  (
    SELECT 
      *,
      ROW_NUMBER() OVER (PARTITION BY CRIME_ID, UPDATED_LOCATION ORDER BY LAST_UPDATED DESC) AS RN
    FROM TRANSFORMED_DATA
  )
  WHERE RN = 1
)

SELECT 
    CRIME_ID,
    CRIME_DATE,
    REPORTED_BY,
    FALLS_WITHIN,
    LONGITUDE,
    LATITUDE,
    UPDATED_LOCATION,
    LSOA_CODE,
    LSOA_NAME,
    CRIME_TYPE,
    LAST_OUTCOME,
    CONTEXT,
    LAST_UPDATED
FROM DEDUPLICATED_DATA